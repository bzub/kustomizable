# Kustomizable

A curated collection of components meant to be built/modified using
[kustomize](https://github.com/kubernetes-sigs/kustomize) and applied to
Kubernetes clusters.

## Project Principles

- Base kustomizations should:
  - Define a ConfigMap in the `kustomization.yaml` to configure the application.
  - Implement generic best-practices like:
    - {liveness,readiness} probes.
    - Prometheus scrape annotations.
  - Reference secrets by name, leaving their implementation to the user.
  - Be small, as in deployable to a default minikube cluster.
    - 1 replica where applicable.
  - Use emptyDir volumes where persistent storage is expected.
    - Storage is domain-specific and should be kustomized by the user.

- Overlay kustomizations should:
  - Represent the most common modifications of a base (highly-available replicas, etc)
  - Serve as examples for user overlays.

## Bootstrap Jobs

Bootstrap jobs in this repository only deploy a Kubernetes Job, which usually:
- Performs a one-time task.
- Generates resources that shouldn't be in version control (secrets).
- Generates resources with names that base kustomizations refer to.

The resources generated by these jobs can then be used in a few ways.

### [etcd/tls-bootstrap](etcd/tls-bootstrap) example

#### Method 1 - Cluster-only secrets

This method deploys [etcd/base](etcd/base) and etcd/tls-bootstrap in parallel.
The etcd pod(s) start after the tls-bootstrap job creates the secret they need.

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - "github.com/bzub/kustomizable/etcd/base"
  - "github.com/bzub/kustomizable/etcd/tls-bootstrap"
```

#### Method 2 - Fetch and use secrets locally

This method involves fetching the TLS resources locally to be managed by
kustomize or kubectl.

##### Step 1 - Deploy etcd/tls-bootstrap standalone

```sh
kubectl create namespace example

kustomize build "github.com/bzub/kustomizable/etcd/tls-bootstrap" | \
    kubectl -n example create -f -
```

##### Step 2 - Download the TLS resources to a directory of files

Using [fetch-secret.sh](tools/fetch-secret.sh) from this repo:

```sh
SECRET_DIR=./secrets/pki/etcd fetch-secret.sh -n example etcd-certs
```

##### Step 3 - Reference the files in an etcd-based kustomization

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - "github.com/bzub/kustomizable/etcd/base"

namespace: etcd-example

secretGenerator:
  - name: etcd-certs
    files:
      - secrets/pki/etcd/ca.crt
      - secrets/pki/etcd/ca.key
      - secrets/pki/etcd/client.crt
      - secrets/pki/etcd/client.key
      - secrets/pki/etcd/peer.crt
      - secrets/pki/etcd/peer.key
      - secrets/pki/etcd/server.crt
      - secrets/pki/etcd/server.key
```
